\chapter{Grid}\label{chapter-grid}

\begin{lstlisting}[language=python, title=run\_test.sh, frame=tb]
  "#grid_generation_method" : {
      "#import" : "$GRID_DIR",
      "#cartesian" : {
        "origin"  : [0.0, 0.0, -5900.0 ],
        "inteval" : [ 100.0, 100.0, 100.0 ]
      },
      "layer_interp" : {
        "in_grid_layer_file" : "$EXEC_DIR/test/test_grid.gdlay",  
        "refine_factor" : [ 1, 1, 1 ],
        "horizontal_start_index" : [ 3, 3 ],
        "vertical_ToFreeSurf_resample_index" : 0
      }
  },
  "is_export_grid" : 1,
  "grid_export_dir"   : "$GRID_DIR",               
\end{lstlisting}

In the configuration of grid, we can choose different grid generation methods. \\

(1) if \texttt{import} is selected, we can directly import the grid file from the outside. \texttt{\$GRID\_DIR}  is the file path and name. \\

(2) if \texttt{cartesian} is selected, we can get the grid through interpolation with several given control interfaces. we can generate grids in Cartesian coordinates. Two parameters are required here, \texttt{origin} is the starting coordinate of the grid and \texttt{inteval} is the grid spacing. \\

(3) if \texttt{layer\_interp} is selected, we can get the grid through interpolation with several given control interfaces. there need to be a .gdlay file, and the file format is shown in Section \ref{gridlayerinterp}. \\
\texttt{refine\_factor} is resampling control parameters for interface grids. This parameter must be an integer and cannot be zero. eg: If the parameter is 1, it means no resampling; If this parameter is \texttt{-2} or \texttt{-3} , it means two or three times  downsampling; If this parameter is \texttt{2} or \texttt{3} , it means two or three times interpolating. Its value is greater than or equal to the number of ghost points\\
\texttt{horizontal\_start\_index}  and \texttt{vertical\_ToFreeSurf\_resample\_index} intercept sub-models from the interface control model. \\
\texttt{horizontal\_start\_index} is x and y start index of  interface before resampling. Note: ensure that after resampling, three points must be set aside as ghost points outside the sub-model. eg: If you do not resample, the minimum value of this parameter is 3; If you do two or three times  downsampling, the minimum value of this parameter is 6 or 10; If you do two or three times interpolating, the minimum value of this parameter is 2 or 1; \\
\texttt{vertical\_ToFreeSurf\_resample\_index} is index to free surface. If this parameter is \texttt{0}, it means selecting the submodel that contains the free surface; If this parameter is \texttt{40}, it means selecting the submodel that intercepted at 40 nodes from the free surface  in the resampled interface control model. 
%===================================================================
\section{Layer Interp} \label{gridlayerinterp}
The \textbf{layer\_interp} function interpolates the spatial grid of the model through the given interface.

\subsection{File Format (.gdlay)}

The following description ignores comment lines and blank lines.
\begin{itemize}
 \item The first line is the number of interface.
 \item {The second line is the cells of each layer.}
 \item {The third line is isequal of each layer.}
  \item {The fourth line is number of interface grids in X and Y directions.}
  \item {Each subsequent line is the X, Y and Z coordinates of the grids.}
\end{itemize}

\subsection{Example}

A model with a horizontal interface can be given as:

\begin{lstlisting}[language=python, title=test.gdlay, frame=tb]
  4
  20    10    20
  1       0     1    
 100  100
    100.0    100.0  -5000.0   
    200.0    100.0  -5000.0
    300.0    100.0  -5000.0
    400.0    100.0  -5000.0
     ...      ...      ... 
\end{lstlisting}
The given interface model have 4 interfaces. \\
There are 20 cells between the first interface and the second interface; there are 10 cells between the second interface and the third interface; there are 20 cells between the third interface and the fourth interface. The first interface is the deepest underground interface, and the last is the free surface interface. \\
The cell spacing between the first interface and the second interface are equal; the cell spacing between the third interface and the fourth interface are equal; the cell spacing between the second interface and the third interface is gradual.\\
The number of interface grids in X is 100 and the number of interface grids in Y is 100. The number of interface grids in Z is 51 ( 4+(20-1)+(10-1)+(20-1) ). \\

The given interface model size is \texttt{100*100*51} .
In fact, the largest model area we can calculate is \texttt{(100-2\*fdx\_nghosts)*(100-2\*fdy\_nghosts)*(51-fdz\_nghosts)}. 
(In this program, these parameters \texttt{fdx\_nghosts, fdy\_nghosts, fdz\_nghosts} are colonization 3). So the largest model area we can calculate is \texttt{94*94*48}.  \\

(1) Example of the maximum area we can calculate without resampling: \\
\texttt{number\_of\_total\_grid\_points\_x = 94}, \\
\texttt{number\_of\_total\_grid\_points\_y = 94}, \\
\texttt{number\_of\_total\_grid\_points\_z = 48},  \\
\begin{lstlisting}[language=python, title=run\_test.sh, frame=tb]
      "layer_interp" : {
        "in_grid_layer_file" : "$EXEC_DIR/test/test_grid.gdlay",  
        "refine_factor" : [ 1, 1, 1 ],
        "horizontal_start_index" : [ 3, 3 ],
        "vertical_ToFreeSurf_resample_index" : 0
      }        
\end{lstlisting}
the calculation area index range of x is \texttt{3->96}, \\
the calculation area index range of y is \texttt{3->96}, \\
the calculation area index range of z is \texttt{3->50}. \\
In the x direction, ghosts points is \texttt{0->2}, and \texttt{97->99}, \\
in the y direction, ghosts points is \texttt{0->2}, and \texttt{97->99}, \\
In the z direction, ghosts points is \texttt{0->2}.\\

(2) Example of the partial area we can calculate without resampling: \\
\texttt{number\_of\_total\_grid\_points\_x = 50}, \\
\texttt{number\_of\_total\_grid\_points\_y = 40}, \\
\texttt{number\_of\_total\_grid\_points\_z = 25}.  \\
\begin{lstlisting}[language=python, title=run\_test.sh, frame=tb]
      "layer_interp" : {
        "in_grid_layer_file" : "$EXEC_DIR/test/test_grid.gdlay",  
        "refine_factor" : [ 1, 1, 1 ],
        "horizontal_start_index" : [ 20, 35 ],
        "vertical_ToFreeSurf_resample_index" : 10
      }        
\end{lstlisting}
the calculation area index range of x is \texttt{20->69}, \\
the calculation area index range of y is \texttt{35->74}, \\
the calculation area index range of z is \texttt{16->40}. \\
In the x direction, ghosts points is \texttt{17->19}, and \texttt{70->72}, \\
in the y direction, ghosts points is \texttt{32->34}, and \texttt{75->77}, \\
In the z direction, ghosts points is \texttt{13->15}, and \texttt{41->42}. \\

%number\_of\_total\_grid_points\_x
We provide a more complex model in the \texttt{example/prep\_grid} directory.

